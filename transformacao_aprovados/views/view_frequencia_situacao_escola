CREATE OR REPLACE VIEW view_situacao_por_escola_anual AS
SELECT
    dtemp.ano AS ano_registro,
    de.nome_escola,
    de.codigo_escola,
    ds.situacao_nome,
    COUNT(fm.matricula) AS contagem_situacao
FROM
    fato_matricula fm
JOIN
    dim_escola de ON fm.id_escola = de.id_escola
JOIN
    dim_situacao ds ON fm.id_situacao = ds.id_situacao
JOIN
    dim_tempo dtemp ON fm.id_tempo = dtemp.id_tempo
GROUP BY
    dtemp.ano, de.nome_escola, de.codigo_escola, ds.situacao_nome
ORDER BY
    dtemp.ano, de.nome_escola, contagem_situacao DESC;